#!/bin/bash

source "$HOME/.config/sketchybar/themes/env.sh"
PLUGIN_DIR="$CONFIG_DIR/plugins"

##### Load theme and layout (env.sh has THEME_DIR, CONFIG_DIR, DARK/LIGHT_THEME, layout constants; THEME from system appearance) #####
source "$THEME_DIR/${THEME}.sh"
source "$THEME_DIR/helpers.sh"

##### Bar Appearance #####
sketchybar --bar \
  notch_display_height=$BAR_HEIGHT \
  position=top \
  topmost=window \
  sticky=on \
  padding_left=$BAR_PADDING \
  padding_right=$BAR_PADDING \
  color=$(c "$BASE") \
  border_width=$BAR_BORDER_WIDTH \
  border_color=$(c "$SURFACE1") \
  blur_radius=$BAR_BLUR_RADIUS \
  shadow=off

##### Defaults #####
sketchybar --default \
  updates=when_shown \
  icon.font="$FONT:Regular:$FONT_SIZE" \
  icon.color=$(c "$TEXT") \
  label.font="$FONT:Regular:$FONT_SIZE" \
  label.color=$(c "$TEXT") \
  padding_left=$PADDING_DEFAULT \
  padding_right=$PADDING_DEFAULT

##### Theme: switch on system dark/light mode change (no restart; update colors in place) #####
sketchybar --add event theme_change "AppleInterfaceThemeChangedNotification"
sketchybar --add item theme_watcher left
sketchybar --set theme_watcher drawing=off script="bash $PLUGIN_DIR/theme_change.sh"
sketchybar --subscribe theme_watcher theme_change

##### Left: AeroSpace Workspaces (see AeroSpace goodies: show workspaces in Sketchybar) #####
sketchybar --add event aerospace_workspace_change

for ws in $($AEROSPACE list-workspaces --all 2>/dev/null); do
  sid=$(echo "$ws" | tr '#+' '__')
  # Display label: strip leading "N-" from workspace name (e.g. 1-Work -> Work, 9-chat -> chat)
  ws_label="$ws"
  [[ "$ws" =~ ^[0-9]+-(.+)$ ]] && ws_label="${BASH_REMATCH[1]}"
  # Workspace: one item — icon (ICON font) + label (FONT)
  sketchybar \
    --add item "space.$sid" left \
    --subscribe "space.$sid" aerospace_workspace_change \
    --set "space.$sid" \
      icon.font="$SPACE_ICON_FONT" \
      icon= \
      label.font="$SPACE_LABEL_FONT" \
      label="$ws_label" \
      icon.padding_left=$SPACE_ICON_PADDING_LEFT \
      icon.padding_right=$SPACE_ICONS_PADDING_LEFT \
      label.padding_right=$SPACE_LABEL_PADDING_RIGHT \
      padding_left=$SPACE_PADDING_LEFT \
      padding_right=$SPACE_PADDING_RIGHT \
      background.height=$PILL_HEIGHT \
      background.corner_radius=$PILL_CORNER_RADIUS \
      background.drawing=off \
      background.color=$(c "$BLUE") \
      icon.color=$(c "$SUBTEXT1") \
      label.color=$(c "$SUBTEXT1") \
      click_script="$AEROSPACE workspace \"$ws\"" \
      script="bash $PLUGIN_DIR/aerospace.sh \"$ws\""
done

##### Right: Next Meeting (Notion Calendar style) + Current Window + Network + RAM + Date/Clock (rainbow icons) #####
sketchybar --add item next_meeting right \
  --set next_meeting \
    icon=󰃰 \
    icon.padding_right=$PADDING_ICON_RIGHT \
    icon.color=$(c "$RED") \
    label="" \
    label.color=$(c "$TEXT") \
    update_freq=$UPDATE_FREQ_MINUTE \
    script="bash $PLUGIN_DIR/next_meeting.sh" \
    click_script="bash $PLUGIN_DIR/meeting_popup.sh next_meeting" \
    popup.align=right \
    popup.height=$POPUP_HEIGHT

sketchybar --add item next_meeting.1 popup.next_meeting \
  --set next_meeting.1 \
    label="—" \
    drawing=off \
    label.font="$FONT:Regular:$FONT_SIZE_SMALL"

sketchybar --add item next_meeting.2 popup.next_meeting \
  --set next_meeting.2 \
    label="—" \
    drawing=off \
    label.font="$FONT:Regular:$FONT_SIZE_SMALL"

sketchybar --add item next_meeting.3 popup.next_meeting \
  --set next_meeting.3 \
    label="—" \
    drawing=off \
    label.font="$FONT:Regular:$FONT_SIZE_SMALL"

sketchybar --add item next_meeting.4 popup.next_meeting \
  --set next_meeting.4 \
    label="—" \
    drawing=off \
    label.font="$FONT:Regular:$FONT_SIZE_SMALL"

sketchybar --add item current_window right \
  --set current_window \
    icon= \
    icon.padding_right=$PADDING_ICON_RIGHT \
    icon.color=$(c "$PEACH") \
    label="—" \
    label.color=$(c "$TEXT") \
    update_freq=$UPDATE_FREQ_FAST \
    script="bash $PLUGIN_DIR/current_window.sh"

sketchybar --add item caffeinate right \
  --set caffeinate \
    icon='' \
    update_freq=$UPDATE_FREQ_MED \
    script="bash $PLUGIN_DIR/caffeinate.sh" \
    click_script="bash $PLUGIN_DIR/caffeinate.sh toggle" \
    icon.color=$(c "$GREEN")

sketchybar --add item battery right \
  --set battery \
    icon.font="$MAC_SF_SYMBOLS" \
    icon.padding_right=$PADDING_ICON_RIGHT \
    icon.color=$(c "$GREEN") \
    label.color=$(c "$TEXT") \
    update_freq=$UPDATE_FREQ_MINUTE \
    script="bash $PLUGIN_DIR/battery.sh"

sketchybar --add item ram right \
  --set ram \
    icon.padding_right=$PADDING_ICON_RIGHT \
    icon.color=$(c "$SKY") \
    update_freq=$UPDATE_FREQ_MED \
    script="bash $PLUGIN_DIR/ram.sh" \
    label.color=$(c "$TEXT")

sketchybar --add item clock right \
  --set clock \
    update_freq=$UPDATE_FREQ_SLOW \
    icon=󰃰 \
    icon.padding_right=$PADDING_ICON_RIGHT \
    icon.color=$(c "$MAUVE") \
    label.color=$(c "$TEXT") \
    script="sketchybar --set \$NAME label=\"\$(date '+%a %d %B  %H:%M')\""

##### Initialize #####
sketchybar --update
